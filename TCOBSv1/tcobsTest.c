
#include <stdint.h>
#include <string.h>
#include "tcobs.h"
#include "tcobsInternal.h"

//! dataSet contains only representative data for debugging.
//! The more intensive testing is done from Go using CGO.
static uint8_t dataSet[] = {
  //len, data...
#if 0
#else
// 00
	0, // decoded
	0, // encoded
// 01
	1, 0x00,
	1, Z1,

	1, 0xFF,
	2, 0xFF, N|1,

	6, 0, 0, 0, 0, 0, 0xFF, 
	4,      Z3,   Z2, 0xFF, N|1, 

	5, 0xFF, 0x02, 0x02, 0x00, 0xFF,
	6, 0xFF, 0x02, 0x02, 0x23, 0xFF, 0xA1,
// 05
	//	{[]byte{0, 0xAA}, []byte{0x20, 0xAA, 0xA1}},
	2, 0x00, 0xAA,
	3, 0x20, 0xAA, 0xA1,
	//	{[]byte{0, 0xFF}, []byte{0x20, 0xFF, 0xA1}},
	2, 0, 0xFF,
	3, 0x20, 0xFF, 0xA1,
	//	{[]byte{0, 0}, []byte{0x40}},
	2, 0, 0,
	1, 0x40,
	//	{[]byte{0, 0, 0xAA}, []byte{0x40, 0xAA, 0xA1}},
	3, 0, 0, 0xAA,
	3, 0x40, 0xAA, 0xA1,
	//	{[]byte{0, 0, 0xFF}, []byte{0x40, 0xFF, 0xA1}},
	3, 0, 0, 0xFF,
	3, 0x40, 0xFF, 0xA1,
// 0a	//	{[]byte{0, 0, 0}, []byte{0x60}},
	3, 0, 0, 0,
	1, 0x60,
	//	{[]byte{0, 0, 0, 0xAA}, []byte{0x60, 0xAA, 0xA1}},
	4, 0, 0, 0, 0xAA,
	3, 0x60, 0xAA, 0xA1,
	//	{[]byte{0, 0, 0, 0xFF}, []byte{0x60, 0xFF, 0xA1}},
	4, 0, 0, 0, 0xFF,
	3, 0x60, 0xFF, 0xA1,
	//	{[]byte{0, 0, 0, 0}, []byte{0x60, 0x20}},
	4, 0, 0, 0, 0,
	2, 0x60, 0x20,
	//	{[]byte{0, 0, 0, 0, 0}, []byte{0x60, 0x40}},
	5, 0, 0, 0, 0, 0,
	2, 0x60, 0x40,
	//	{[]byte{0, 0, 0, 0, 0, 0xFF}, []byte{0x60, 0x40, 0xFF, 0xA1}},
	6, 0, 0, 0, 0, 0, 0xFF,
	4, 0x60, 0x40, 0xFF, 0xA1,
// 10 //	{[]byte{0, 0, 0, 0, 0, 0xAA}, []byte{0x60, 0x40, 0xAA, 0xA1}},
	6, 0, 0, 0, 0, 0, 0xAA,
	4, 0x60, 0x40, 0xAA, 0xA1,
	//	{[]byte{0, 0, 0, 0, 0, 0, 0xFF}, []byte{0x60, 0x60, 0xFF, 0xA1}},
	7, 0, 0, 0, 0, 0, 0, 0xFF,
	4, 0x60, 0x60, 0xFF, 0xA1,
	//	{[]byte{0xAA}, []byte{0xAA, 0xA1}},
	1, 0xAA,
	2, 0xAA, 0xA1,
	//	{[]byte{0xAA, 0xAA}, []byte{0xAA, 0xAA, 0xA2}},
	2, 0xAA, 0xAA,
	3, 0xAA, 0xAA, 0xA2,
	//	{[]byte{0xAA, 0xBB}, []byte{0xAA, 0xBB, 0xA2}},
	2, 0xAA, 0xBB,
	3, 0xAA, 0xBB, 0xA2,
	//	{[]byte{0xFF}, []byte{0xFF, 0xA1}},
	1, 0xFF,
	2, 0xFF, 0xA1,
	//	{[]byte{0xFF, 0x00}, []byte{0xFF, 0x21}},
	2, 0xFF, 0x00,
	2, 0xFF, 0x21,
// 017 //	{[]byte{0xFF, 0xAA}, []byte{0xFF, 0xAA, 0xA2}},
	2, 0xFF, 0xAA,
	3, 0xFF, 0xAA, 0xA2,
// 018 //	{[]byte{0xFF, 0xFF}, []byte{0xC0}},
	2, 0xFF, 0xFF,
	1, 0xC0,
	//	{[]byte{0xFF, 0xFF, 0x00}, []byte{0xC0, 0x20}},
	3, 0xFF, 0xFF, 0x00,
	2, 0xC0, 0x20,
	//	{[]byte{0xFF, 0xFF, 0xAA}, []byte{0xC0, 0xAA, 0xA1}},
	3, 0xFF, 0xFF, 0xAA,
	3, 0xC0, 0xAA, 0xA1,
	//	{[]byte{0xFF, 0xFF, 0xFF}, []byte{0xE0}},
	3, 0xFF, 0xFF, 0xFF,
	1, 0xE0,
// 1c //	{[]byte{0xFF, 0xFF, 0xFF, 0x00}, []byte{0xE0, 0x20}},
	4, 0xFF, 0xFF, 0xFF, 0x00,
	2, 0xE0, 0x20,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xAA}, []byte{0xE0, 0xAA, 0xA1}},
	4, 0xFF, 0xFF, 0xFF, 0xAA,
	3, 0xE0, 0xAA, 0xA1,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF}, []byte{0x80}},
	4, 0xFF, 0xFF, 0xFF, 0xFF,
	1, 0x80,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0x00}, []byte{0x80, 0x20}},
	5, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
	2, 0x80, 0x20,
// 20 //	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xAA}, []byte{0x80, 0xAA, 0xA1}},
	5, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA,
	3, 0x80, 0xAA, 0xA1,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, []byte{0x80, 0xFF, 0xA1}},
	5, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	3, 0x80, 0xFF, 0xA1,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00}, []byte{0x80, 0xFF, 0x21}},
	6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
	3, 0x80, 0xFF, 0x21,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA}, []byte{0x80, 0xFF, 0xAA, 0xA2}},
	6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA,
	4, 0x80, 0xFF, 0xAA, 0xA2,
// 24	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, []byte{0x80, 0xC0}},
	6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	2, 0x80, 0xC0,
	//	{[]byte{0xAA, 0xAA}, []byte{0xAA, 0xAA, 0xA2}},
	2, 0xAA, 0xAA,
	3, 0xAA, 0xAA, 0xA2,
	//	{[]byte{0xAA, 0xAA, 0xAA}, []byte{0xAA, 0x09}},             // AA R2
	3, 0xAA, 0xAA, 0xAA,
	2, 0xAA, 0x09,
	//	{[]byte{0xAA, 0xAA, 0xAA, 0xAA}, []byte{0xAA, 0x11}},       // AA R3
	4, 0xAA, 0xAA, 0xAA, 0xAA,
	2, 0xAA, 0x11,
// 28 //	{[]byte{0xAA, 0xAA, 0xAA, 0xAA, 0xAA}, []byte{0xAA, 0x19}}, // AA R4
	5, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
	2, 0xAA, 0x19,
	//	{[]byte{0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA}, []byte{0xAA, 0x19, 0xAA, 0xA1}},
	6, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
	4, 0xAA, 0x19, 0xAA, 0xA1,
	//	{[]byte{0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA}, []byte{0xAA, 0x19, 0xAA, 0xAA, 0xA2}},
	7, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
	5, 0xAA, 0x19, 0xAA, 0xAA, 0xA2,
	//	{[]byte{0xAA, 0x00}, []byte{0xAA, 0x21}},
	2, 0xAA, 0x00,
	2, 0xAA, 0x21,
// 2c //	{[]byte{0xAA, 0xAA, 0x00}, []byte{0xAA, 0xAA, 0x22}},
	3, 0xAA, 0xAA, 0x00,
	3, 0xAA, 0xAA, 0x22,
	//	{[]byte{0xFF, 0x02, 0x02, 0x00}, []byte{0xFF, 0x02, 0x02, 0x23}},
	4, 0xFF, 0x02, 0x02, 0x00,
	4, 0xFF, 0x02, 0x02, 0x23,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xAA, 0xFF, 0xFF}, []byte{0x80, 0xAA, 0xC1}},
	7, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA, 0xFF, 0xFF,
	3, 0x80, 0xAA, 0xC1,
	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF}, []byte{0x80, 0x20, 0xC0}},
	7, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF,
	3, 0x80, 0x20, 0xC0,
// 30	//	{[]byte{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA, 0xFF, 0xFF}, []byte{0x80, 0xFF, 0xAA, 0xC2}},
	8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAA, 0xFF, 0xFF,
	4, 0x80, 0xFF, 0xAA, 0xC2,
	//	{[]byte{0, 0, 0, 0, 0, 0xAA, 0xFF, 0xFF, 0xAA}, []byte{0x60, 0x40, 0xAA, 0xC1, 0xAA, 0xA1}},
	9, 0, 0, 0, 0, 0, 0xAA, 0xFF, 0xFF, 0xAA,
	6, 0x60, 0x40, 0xAA, 0xC1, 0xAA, 0xA1,
	//	{[]byte{0, 2, 2, 2, 0, 1, 0, 255, 255, 255, 1, 2, 1, 0, 255, 1, 2, 0, 0, 1, 2, 1, 255, 1, 2, 2, 2, 255, 1, 2, 0, 255, 2, 2, 0},
	//		[]byte{0x20, 0x2, 0x9, 0x20, 0x1, 0x21, 0xe0, 0x1, 0x2, 0x1, 0x23, 0xff, 0x1, 0x2, 0x43, 0x1, 0x2, 0x1, 0xff, 0x1, 0x2, 0xe, 0xff, 0x1, 0x2, 0x23, 0xff, 0x2, 0x2, 0x23}},
	35, 0, 2, 2, 2, 0, 1, 0, 255, 255, 255, 1, 2, 1, 0, 255, 1, 2, 0, 0, 1, 2, 1, 255, 1, 2, 2, 2, 255, 1, 2, 0, 255, 2, 2, 0,
	30, 0x20, 0x2, 0x9, 0x20, 0x1, 0x21, 0xe0, 0x1, 0x2, 0x1, 0x23, 0xff, 0x1, 0x2, 0x43, 0x1, 0x2, 0x1, 0xff, 0x1, 0x2, 0xe, 0xff, 0x1, 0x2, 0x23, 0xff, 0x2, 0x2, 0x23,
#endif
};

#define OMAX 100 //!< max expected output buffer size
static uint8_t obuf[OMAX]; //!< output buffer
int k;
    int olen, dlen, elen;

void TCOBSEncodeTest( void ){
    uint8_t *limit = dataSet + sizeof(dataSet);
    uint8_t *enc, *dec = dataSet;
    k = 0;
    do{
        dlen = *dec++;
        enc  = dec + dlen;
        elen = *enc++;
        olen = TCOBSEncode( obuf, dec, dlen );
        
        if( olen != elen ){
            for(;;);
        }
        for( int i = 0; i < olen; i++ ){
            if( obuf[i] != enc[i] ){ 
                for(;;){} 
            }
        }
        dec  = enc + elen;
        k++;
    }while( dec < limit );
}

void TCOBSDecodeTest( void ){
    uint8_t *limit = dataSet + sizeof(dataSet);
    uint8_t *enc, *dec = dataSet;
    int olen, dlen, elen;
    uint8_t *out;
    k = 0;
    do{
        dlen = *dec++;
        enc  = dec + dlen;
        elen = *enc++;
        olen = TCOBSDecode( obuf, OMAX, enc, elen );
        
        if( olen != dlen ){ 
            for(;;){} 
        }
        out = obuf + OMAX - olen;
        for( int i = 0; i < olen; i++ ){
            if( out[i] != dec[i] ){ 
                for(;;){} 
            } 
        }
        dec  = enc + elen;
        k++;
    }while( dec < limit );
}

